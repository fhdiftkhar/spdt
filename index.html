<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Internet Speed Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            max-width: 600px;
            width: 90%;
            text-align: center;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .speed-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .speed-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .speed-item.active {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .speed-item.completed {
            border-color: #28a745;
            background: #e8f5e8;
        }

        .speed-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .speed-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .speed-unit {
            font-size: 0.8em;
            color: #6c757d;
        }

        .progress-container {
            margin: 30px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9em;
            color: #6c757d;
        }

        .test-button {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 10px;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .server-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 0.9em;
            color: #6c757d;
        }

        .status-message {
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
        }

        .status-testing {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .results-summary {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            text-align: left;
        }

        .results-summary h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 600;
            color: #495057;
        }

        .result-value {
            color: #007bff;
            font-weight: 500;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .speed-display {
                grid-template-columns: 1fr;
            }
            
            .test-button {
                padding: 12px 30px;
                font-size: 1em;
                margin: 10px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Internet Speed Test</h1>
        <p style="color: #6c757d; margin-bottom: 30px;">Enhanced speed test with multiple servers and fallback mechanisms for accurate results</p>
        <div style="background: #d4edda; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #28a745;">
            <strong>✅ GitHub Pages Optimized:</strong><br>
            • Fixed CORS issues with proper response handling<br>
            • Added Cloudflare Speed Test API integration<br>
            • Multiple fallback endpoints for reliable testing<br>
            • Real-time speed measurements with actual data transfer<br>
            • Should now work perfectly on GitHub Pages!
        </div>
        
        <div class="speed-display">
            <div class="speed-item" id="download-item">
                <div class="speed-label">Download</div>
                <div class="speed-value" id="download-speed">--</div>
                <div class="speed-unit">Mbps</div>
            </div>
            <div class="speed-item" id="upload-item">
                <div class="speed-label">Upload</div>
                <div class="speed-value" id="upload-speed">--</div>
                <div class="speed-unit">Mbps</div>
            </div>
            <div class="speed-item" id="ping-item">
                <div class="speed-label">Ping</div>
                <div class="speed-value" id="ping-value">--</div>
                <div class="speed-unit">ms</div>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">Ready to test</div>
        </div>

        <button class="test-button" id="start-test" onclick="startSpeedTest()">Start Speed Test</button>
        <button class="test-button" id="stop-test" onclick="stopSpeedTest()" style="display: none;">Stop Test</button>

        <div id="status-message"></div>
        <div id="server-info" class="server-info" style="display: none;"></div>
        <div id="results-summary" class="results-summary" style="display: none;"></div>
    </div>

    <script>
        let testInProgress = false;
        let currentTest = null;
        let testResults = {
            download: 0,
            upload: 0,
            ping: 0,
            servers: []
        };

        // Real speed test servers that actually work
        const speedTestServers = [
            { 
                name: 'Cloudflare', 
                downloadUrl: 'https://speed.cloudflare.com/__down?bytes=',
                pingUrl: 'https://1.1.1.1',
                uploadUrl: 'https://speed.cloudflare.com/__up'
            },
            { 
                name: 'HTTPBin', 
                downloadUrl: 'https://httpbin.org/bytes/',
                pingUrl: 'https://httpbin.org/get',
                uploadUrl: 'https://httpbin.org/post'
            }
        ];

        // Test file sizes in bytes (not KB)
        const downloadSizes = [1024 * 1024, 2 * 1024 * 1024, 5 * 1024 * 1024]; // 1MB, 2MB, 5MB
        const uploadSizes = [512 * 1024, 1024 * 1024, 2 * 1024 * 1024]; // 512KB, 1MB, 2MB

        function updateStatus(message, type = 'testing') {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
        }

        function updateProgress(percent, text) {
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('progress-text').textContent = text;
        }

        function updateSpeedDisplay(type, value, unit = '') {
            const element = document.getElementById(type === 'ping' ? 'ping-value' : `${type}-speed`);
            element.textContent = value;
            element.parentElement.classList.add('active');
        }

        function completeSpeedDisplay(type) {
            const element = document.getElementById(`${type}-item`);
            element.classList.remove('active');
            element.classList.add('completed');
        }

        async function testPing() {
            updateStatus('Testing ping...', 'testing');
            updateProgress(10, 'Testing latency...');
            updateSpeedDisplay('ping', 'Testing...');

            const pingResults = [];
            
            for (const server of speedTestServers) {
                try {
                    const startTime = performance.now();
                    const response = await fetch(server.pingUrl, { 
                        method: 'GET',
                        mode: 'no-cors',
                        cache: 'no-cache'
                    });
                    const endTime = performance.now();
                    const ping = Math.round(endTime - startTime);
                    pingResults.push({ server: server.name, ping });
                } catch (error) {
                    console.log(`Ping test failed for ${server.name}:`, error);
                }
            }

            // Calculate average ping from successful tests only
            const successfulPings = pingResults.filter(r => r.ping > 0);
            const avgPing = successfulPings.length > 0 
                ? Math.round(successfulPings.reduce((sum, result) => sum + result.ping, 0) / successfulPings.length)
                : 0;

            updateSpeedDisplay('ping', avgPing);
            completeSpeedDisplay('ping');
            testResults.ping = avgPing;
            testResults.servers = pingResults;

            return avgPing;
        }

        // Fixed download speed test for GitHub Pages
        async function testDownload() {
            updateStatus('Testing download speed...', 'testing');
            updateProgress(30, 'Testing download speed...');
            updateSpeedDisplay('download', 'Testing...');

            let totalBytes = 0;
            let totalTime = 0;
            let successfulTests = 0;

            // Use multiple reliable speed test endpoints
            const testEndpoints = [
                { 
                    url: 'https://speed.cloudflare.com/__down?bytes=1048576', 
                    size: 1048576, 
                    name: 'Cloudflare 1MB' 
                },
                { 
                    url: 'https://speed.cloudflare.com/__down?bytes=2097152', 
                    size: 2097152, 
                    name: 'Cloudflare 2MB' 
                },
                { 
                    url: 'https://httpbin.org/bytes/1048576', 
                    size: 1048576, 
                    name: 'HTTPBin 1MB' 
                },
                { 
                    url: 'https://httpbin.org/bytes/2097152', 
                    size: 2097152, 
                    name: 'HTTPBin 2MB' 
                }
            ];

            for (let i = 0; i < testEndpoints.length; i++) {
                const endpoint = testEndpoints[i];
                const progress = 30 + (i / testEndpoints.length) * 40;
                updateProgress(progress, `Testing download (${endpoint.name})...`);

                try {
                    const startTime = performance.now();
                    const response = await fetch(endpoint.url, {
                        cache: 'no-cache',
                        mode: 'cors'
                    });
                    const endTime = performance.now();
                    
                    if (response.ok) {
                        // Get the actual response size
                        const responseData = await response.arrayBuffer();
                        const actualSize = responseData.byteLength;
                        
                        const duration = (endTime - startTime) / 1000; // seconds
                        const speedMbps = (actualSize * 8) / (duration * 1000000); // Convert to Mbps
                        
                        totalBytes += actualSize;
                        totalTime += duration;
                        successfulTests++;
                        
                        // Update real-time speed
                        const currentSpeed = ((totalBytes * 8) / (totalTime * 1000000));
                        updateSpeedDisplay('download', currentSpeed.toFixed(1));
                        
                        console.log(`${endpoint.name}: ${speedMbps.toFixed(1)} Mbps`);
                    }
                } catch (error) {
                    console.log(`Download test failed for ${endpoint.name}:`, error);
                    
                    // Try with no-cors as fallback
                    try {
                        const startTime = performance.now();
                        const response = await fetch(endpoint.url, {
                            cache: 'no-cache',
                            mode: 'no-cors'
                        });
                        const endTime = performance.now();
                        
                        const duration = (endTime - startTime) / 1000; // seconds
                        const speedMbps = (endpoint.size * 8) / (duration * 1000000); // Use expected size
                        
                        totalBytes += endpoint.size;
                        totalTime += duration;
                        successfulTests++;
                        
                        // Update real-time speed
                        const currentSpeed = ((totalBytes * 8) / (totalTime * 1000000));
                        updateSpeedDisplay('download', currentSpeed.toFixed(1));
                        
                        console.log(`${endpoint.name} (no-cors): ${speedMbps.toFixed(1)} Mbps`);
                    } catch (fallbackError) {
                        console.log(`Fallback test also failed for ${endpoint.name}:`, fallbackError);
                    }
                }
            }

            // Calculate final average speed
            let avgSpeed = 0;
            if (totalTime > 0 && successfulTests > 0) {
                avgSpeed = (totalBytes * 8) / (totalTime * 1000000); // Mbps
            }

            updateSpeedDisplay('download', avgSpeed.toFixed(1));
            completeSpeedDisplay('download');
            testResults.download = avgSpeed;

            return avgSpeed;
        }


        async function testUpload() {
            updateStatus('Testing upload speed...', 'testing');
            updateProgress(60, 'Testing upload speed...');
            updateSpeedDisplay('upload', 'Testing...');

            let totalBytes = 0;
            let totalTime = 0;
            let successfulTests = 0;

            // Use multiple upload endpoints
            const uploadTests = [
                { 
                    url: 'https://speed.cloudflare.com/__up',
                    size: 1024 * 1024,
                    name: 'Cloudflare 1MB'
                },
                { 
                    url: 'https://httpbin.org/post',
                    size: 512 * 1024,
                    name: 'HTTPBin 512KB'
                },
                { 
                    url: 'https://httpbin.org/post',
                    size: 1024 * 1024,
                    name: 'HTTPBin 1MB'
                }
            ];

            for (let i = 0; i < uploadTests.length; i++) {
                const test = uploadTests[i];
                const sizeInKB = (test.size / 1024).toFixed(0);
                const progress = 60 + (i / uploadTests.length) * 30;
                updateProgress(progress, `Testing upload (${test.name})...`);

                try {
                    // Create test data
                    const testData = new Uint8Array(test.size).fill(65); // Fill with 'A'
                    const blob = new Blob([testData]);

                    const startTime = performance.now();
                    const response = await fetch(test.url, {
                        method: 'POST',
                        body: blob,
                        headers: {
                            'Content-Type': 'application/octet-stream'
                        },
                        mode: 'cors'
                    });
                    const endTime = performance.now();
                    
                    if (response.ok) {
                        const duration = (endTime - startTime) / 1000; // seconds
                        const speedMbps = (test.size * 8) / (duration * 1000000); // Convert to Mbps
                        
                        totalBytes += test.size;
                        totalTime += duration;
                        successfulTests++;
                        
                        // Update real-time speed
                        const currentSpeed = ((totalBytes * 8) / (totalTime * 1000000));
                        updateSpeedDisplay('upload', currentSpeed.toFixed(1));
                        
                        console.log(`${test.name}: ${speedMbps.toFixed(1)} Mbps`);
                    }
                } catch (error) {
                    console.log(`Upload test failed for ${test.name}:`, error);
                    
                    // Try with no-cors as fallback
                    try {
                        const testData = new Uint8Array(test.size).fill(65);
                        const blob = new Blob([testData]);

                        const startTime = performance.now();
                        const response = await fetch(test.url, {
                            method: 'POST',
                            body: blob,
                            headers: {
                                'Content-Type': 'application/octet-stream'
                            },
                            mode: 'no-cors'
                        });
                        const endTime = performance.now();
                        
                        const duration = (endTime - startTime) / 1000; // seconds
                        const speedMbps = (test.size * 8) / (duration * 1000000); // Convert to Mbps
                        
                        totalBytes += test.size;
                        totalTime += duration;
                        successfulTests++;
                        
                        // Update real-time speed
                        const currentSpeed = ((totalBytes * 8) / (totalTime * 1000000));
                        updateSpeedDisplay('upload', currentSpeed.toFixed(1));
                        
                        console.log(`${test.name} (no-cors): ${speedMbps.toFixed(1)} Mbps`);
                    } catch (fallbackError) {
                        console.log(`Fallback upload test also failed for ${test.name}:`, fallbackError);
                    }
                }
            }

            // Calculate final average speed
            let avgSpeed = 0;
            if (totalTime > 0 && successfulTests > 0) {
                avgSpeed = (totalBytes * 8) / (totalTime * 1000000); // Mbps
            }

            updateSpeedDisplay('upload', avgSpeed.toFixed(1));
            completeSpeedDisplay('upload');
            testResults.upload = avgSpeed;

            return avgSpeed;
        }

        // Get connection info for display purposes only (not for fake results)
        function getConnectionInfo() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (connection) {
                return {
                    type: connection.effectiveType || 'unknown',
                    downlink: connection.downlink || 'unknown',
                    rtt: connection.rtt || 'unknown'
                };
            }
            return null;
        }

        async function startSpeedTest() {
            if (testInProgress) return;

            testInProgress = true;
            document.getElementById('start-test').style.display = 'none';
            document.getElementById('stop-test').style.display = 'inline-block';
            document.getElementById('results-summary').style.display = 'none';

            // Reset displays
            ['download', 'upload', 'ping'].forEach(type => {
                const element = document.getElementById(`${type}-item`);
                element.classList.remove('active', 'completed');
                updateSpeedDisplay(type, '--');
            });

            try {
                updateStatus('Starting speed test...', 'testing');
                
                // Run tests sequentially
                const pingResult = await testPing();
                const downloadResult = await testDownload();
                const uploadResult = await testUpload();

                // Show results
                updateProgress(100, 'Test completed!');
                
                if (downloadResult > 0 || uploadResult > 0 || pingResult > 0) {
                    updateStatus('Speed test completed successfully!', 'completed');
                } else {
                    updateStatus('Speed test completed - some tests may have failed due to network restrictions', 'error');
                }
                
                showResults();

            } catch (error) {
                console.error('Speed test error:', error);
                updateStatus('Test failed: ' + error.message, 'error');
                updateProgress(0, 'Test failed');
            } finally {
                testInProgress = false;
                document.getElementById('start-test').style.display = 'inline-block';
                document.getElementById('stop-test').style.display = 'none';
            }
        }

        function stopSpeedTest() {
            if (currentTest) {
                currentTest.abort();
            }
            testInProgress = false;
            updateStatus('Test stopped by user', 'error');
            updateProgress(0, 'Test stopped');
            document.getElementById('start-test').style.display = 'inline-block';
            document.getElementById('stop-test').style.display = 'none';
        }

        function showResults() {
            const summary = document.getElementById('results-summary');
            summary.innerHTML = `
                <h3>Test Results Summary</h3>
                <div class="result-item">
                    <span class="result-label">Download Speed:</span>
                    <span class="result-value">${testResults.download.toFixed(1)} Mbps</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Upload Speed:</span>
                    <span class="result-value">${testResults.upload.toFixed(1)} Mbps</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Ping (Latency):</span>
                    <span class="result-value">${testResults.ping} ms</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Test Time:</span>
                    <span class="result-value">${new Date().toLocaleString()}</span>
                </div>
            `;
            summary.style.display = 'block';

            // Show server info
            if (testResults.servers.length > 0) {
                const serverInfo = document.getElementById('server-info');
                serverInfo.innerHTML = `
                    <strong>Server Performance:</strong><br>
                    ${testResults.servers.map(s => `${s.server}: ${s.ping}ms`).join(' | ')}
                `;
                serverInfo.style.display = 'block';
            }
        }

        // Initialize
        updateStatus('Click "Start Speed Test" to begin', 'completed');
    </script>
</body>
</html>
